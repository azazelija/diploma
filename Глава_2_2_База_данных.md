# 2.2 ПРОЕКТИРОВАНИЕ БАЗЫ ДАННЫХ

Для хранения данных системы управления задачами выбрана реляционная СУБД PostgreSQL версии 13. Выбор обусловлен высокой надёжностью, поддержкой ACID-транзакций, развитыми механизмами индексирования и бесплатной лицензией с открытым исходным кодом.

## 2.2.1 Структура базы данных

База данных состоит из семи взаимосвязанных таблиц, организованных в соответствии с принципами нормализации до третьей нормальной формы. Структура обеспечивает целостность данных, исключает избыточность и позволяет эффективно выполнять операции поиска и модификации.

[Место для вставки ER-диаграммы]

**Рисунок 1 — ER-диаграмма базы данных**

На диаграмме представлены все таблицы базы данных с указанием полей, типов данных, первичных и внешних ключей. Связи между таблицами показаны линиями с обозначением кардинальности (один-ко-многим, многие-ко-многим).

## 2.2.2 Описание таблиц справочников

Таблица **roles** содержит справочник ролей пользователей в системе. Поля: id (первичный ключ, автоинкремент), name (уникальное название роли, VARCHAR(50)), description (описание роли, TEXT), created_at (дата создания, TIMESTAMP). В системе используются две роли: «Администратор» с полными правами и «Пользователь» со стандартными правами.

Таблица **positions** хранит справочник должностей сотрудников организации. Поля: id (первичный ключ), name (уникальное название, VARCHAR(100)), description (описание должности, TEXT), level (числовой уровень от 1 до 7, INTEGER), created_at (дата создания). Справочник содержит должности от стажёра до архитектора с соответствующими уровнями квалификации.

Таблица **task_statuses** представляет справочник статусов задач. Поля: id (первичный ключ), name (уникальное название, VARCHAR(50)), color (цветовой код в формате HEX, VARCHAR(7)), description (описание статуса, TEXT), sort_order (порядок отображения, INTEGER). В справочнике содержатся пять статусов: «Нужно сделать», «В процессе», «На проверке», «Готово», «Отменено» с соответствующими цветовыми кодами для визуализации.

## 2.2.3 Описание таблицы пользователей

Таблица **users** содержит информацию о всех пользователях системы. Структура включает следующие поля:

- id — первичный ключ с автоинкрементом типа SERIAL.
- email — адрес электронной почты, VARCHAR(255), уникальное значение, обязательное поле.
- username — имя пользователя для отображения, VARCHAR(100), обязательное.
- first_name — имя, VARCHAR(100), обязательное.
- last_name — фамилия, VARCHAR(100), обязательное.
- password_hash — хеш пароля, VARCHAR(255), обязательное. Хранится результат bcrypt-хеширования.
- avatar — путь к файлу аватара, TEXT, необязательное.
- role_id — внешний ключ на таблицу roles, INTEGER, обязательное, значение по умолчанию 2 (роль «Пользователь»).
- position_id — внешний ключ на таблицу positions, INTEGER, необязательное.
- created_at — дата и время регистрации, TIMESTAMP, автоматически устанавливается текущее время.
- updated_at — дата и время последнего обновления, TIMESTAMP, обновляется при изменении записи.

Для поля email установлено ограничение уникальности, что предотвращает регистрацию нескольких пользователей с одинаковым адресом. Внешние ключи role_id и position_id обеспечивают ссылочную целостность со справочными таблицами.

## 2.2.4 Описание таблицы задач

Таблица **tasks** является центральной таблицей системы и содержит информацию о всех задачах. Структура таблицы:

- id — первичный ключ типа SERIAL.
- title — название задачи, VARCHAR(255), обязательное поле.
- description — детальное описание задачи, TEXT, необязательное.
- status_id — внешний ключ на task_statuses, INTEGER, обязательное, значение по умолчанию 1.
- priority — приоритет задачи, VARCHAR(20), ограничение CHECK (low, medium, high, urgent), значение по умолчанию medium.
- assigned_to — назначенный исполнитель, внешний ключ на users, INTEGER, необязательное.
- created_by — создатель задачи, внешний ключ на users, INTEGER, обязательное.
- updated_by — пользователь, последним изменивший задачу, внешний ключ на users, INTEGER, необязательное.
- due_date — срок выполнения задачи, TIMESTAMP, необязательное.
- completed_at — дата и время завершения задачи, TIMESTAMP, необязательное.
- created_at — дата и время создания, TIMESTAMP, автоматически.
- updated_at — дата и время последнего изменения, TIMESTAMP, обновляется автоматически.

Для поля priority установлено ограничение CHECK, которое допускает только четыре определённых значения приоритета. Это обеспечивает целостность данных на уровне базы и предотвращает ввод некорректных значений.

## 2.2.5 Вспомогательные таблицы

Таблица **task_comments** предназначена для хранения комментариев к задачам. Поля: id (первичный ключ), task_id (внешний ключ на tasks, обязательное), user_id (внешний ключ на users, обязательное), comment (текст комментария, TEXT, обязательное), created_at и updated_at (временные метки). При удалении задачи все связанные комментарии удаляются автоматически через каскадное удаление (ON DELETE CASCADE).

Таблица **profile_change_requests** содержит запросы пользователей на изменение персональных данных профиля. Структура: id (первичный ключ), user_id (внешний ключ на users), first_name и last_name (новые значения имени и фамилии), status (статус запроса с CHECK-ограничением: pending, approved, rejected), created_at (дата создания запроса), reviewed_at (дата рассмотрения), reviewed_by (администратор, рассмотревший запрос, внешний ключ на users), reject_reason (причина отклонения, TEXT). Данная таблица реализует механизм согласования изменений профиля через администратора.

## 2.2.6 Связи между таблицами

В базе данных реализованы следующие типы связей между таблицами:

**Связь один-ко-многим** между roles и users — каждый пользователь имеет одну роль, роль может быть назначена многим пользователям. Связь реализована через внешний ключ role_id в таблице users с политикой ON DELETE RESTRICT, что предотвращает удаление роли при наличии пользователей с этой ролью.

**Связь один-ко-многим** между positions и users — каждый пользователь может иметь одну должность, должность может быть у многих пользователей. Внешний ключ position_id с политикой ON DELETE SET NULL, что при удалении должности устанавливает NULL в записях пользователей.

**Связь один-ко-многим** между task_statuses и tasks — каждая задача имеет один статус, статус может быть у многих задач. Политика ON DELETE RESTRICT не позволяет удалить статус при наличии задач с этим статусом.

**Связь один-ко-многим** между users и tasks (created_by) — каждый пользователь может создать много задач, задача имеет одного создателя. Политика ON DELETE CASCADE удаляет все задачи при удалении пользователя-создателя.

**Связь один-ко-многим** между users и tasks (assigned_to) — пользователь может быть исполнителем многих задач. Политика ON DELETE SET NULL при удалении пользователя-исполнителя устанавливает NULL в поле assigned_to задач.

## 2.2.7 Индексы базы данных

Для обеспечения высокой производительности запросов созданы следующие индексы:

- idx_tasks_status на поле status_id таблицы tasks — ускоряет фильтрацию задач по статусу для отображения колонок канбан-доски.
- idx_tasks_assigned на поле assigned_to — оптимизирует выборку задач по исполнителю.
- idx_tasks_created_by на поле created_by — ускоряет поиск задач по создателю.
- idx_tasks_due_date на поле due_date — повышает производительность запросов на поиск просроченных задач и сортировку по срокам.
- idx_comments_task на поле task_id таблицы task_comments — ускоряет загрузку комментариев для конкретной задачи.

Индексы типа B-tree создаются автоматически для первичных ключей и полей с ограничением UNIQUE. Для внешних ключей индексы создаются явно, что ускоряет операции JOIN при выборке связанных данных.

## 2.2.8 Ограничения целостности

В базе данных применены следующие механизмы обеспечения целостности:

**Первичные ключи** определены для всех таблиц с типом SERIAL, что обеспечивает автоматическую генерацию уникальных идентификаторов и предотвращает дублирование записей.

**Ограничения уникальности** установлены для полей email в таблице users, name в таблицах roles, positions и task_statuses. Это гарантирует отсутствие дубликатов в справочных данных и адресах электронной почты.

**Ограничения NOT NULL** применены ко всем обязательным полям, что предотвращает вставку неполных данных в критичные поля таблиц.

**CHECK-ограничения** используются для полей priority в tasks и status в profile_change_requests. Они обеспечивают допустимость только предопределённых значений на уровне базы данных.

**Внешние ключи** с различными политиками каскадных операций (CASCADE, RESTRICT, SET NULL) обеспечивают ссылочную целостность между связанными таблицами и контролируют поведение при удалении записей.

Спроектированная структура базы данных соответствует требованиям системы, обеспечивает целостность и согласованность данных, предоставляет механизмы быстрого поиска через индексы. Нормализованная структура исключает избыточность и упрощает поддержку базы данных.
